name: package-installers

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: "21"
      - name: Build fat jar
        run: mvn -DskipTests clean package
      - name: Package DMG
        run: |
          mkdir -p dist/mac
          jpackage --type dmg --dest dist/mac --name KeepAwake --app-version ${GITHUB_REF_NAME#v} --input target --main-jar KeepAwake.jar --main-class com.drew.keepawake.Main --icon icons/mac/KeepAwake.png --vendor "Drew"
      - uses: actions/upload-artifact@v4
        with:
          name: keepawake-macos
          path: dist/mac/*

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: "21"

      - name: Install WiX (needed for MSI)
        shell: pwsh
        run: |
          choco install wixtoolset -y
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Build fat jar
        run: mvn -DskipTests clean package

      - name: Package MSI
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist\windows | Out-Null
          jpackage `
            --type msi `
            --dest dist\windows `
            --name KeepAwake `
            --app-version $env:GITHUB_REF_NAME.TrimStart('v') `
            --input target `
            --main-jar KeepAwake.jar `
            --main-class com.drew.keepawake.Main `
            --icon icons\windows\KeepAwake.ico `
            --vendor "Drew" `
            --win-menu `
            --win-shortcut `
            --win-dir-chooser
      - uses: actions/upload-artifact@v4
        with:
          name: keepawake-windows
          path: dist/windows/*

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: "21"
      - name: Install RPM tooling
        run: sudo apt-get update && sudo apt-get install -y rpm
      - name: Build fat jar
        run: mvn -DskipTests clean package
      - name: Package DEB
        run: |
          mkdir -p dist/linux
          jpackage \
            --type deb \
            --dest dist/linux \
            --name keepawake \
            --app-version ${GITHUB_REF_NAME#v} \
            --input target \
            --main-jar KeepAwake.jar \
            --main-class com.drew.keepawake.Main \
            --icon icons/linux/keepawake.png \
            --vendor "Drew"
      - name: Package RPM
        run: |
          jpackage \
            --type rpm \
            --dest dist/linux \
            --name keepawake \
            --app-version ${GITHUB_REF_NAME#v} \
            --input target \
            --main-jar KeepAwake.jar \
            --main-class com.drew.keepawake.Main \
            --icon icons/linux/keepawake.png \
            --vendor "Drew"
      - uses: actions/upload-artifact@v4
        with:
          name: keepawake-linux
          path: dist/linux/*

  release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist-all

      - name: List downloaded files
        run: ls -R dist-all

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: KeepAwake ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist-all/**/*.dmg
            dist-all/**/*.msi
            dist-all/**/*.deb
            dist-all/**/*.rpm